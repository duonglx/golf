<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOB Year-End Outing 2025 - Pairing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        /* --- CORE THEME --- */
        :root {
            --primary-green: #064e3b; /* Emerald 900 */
            --accent-gold: #fbbf24;   /* Amber 400 */
        }

        /* GLOBAL FONT SETTING */
        body { font-family: 'Montserrat', sans-serif; background-color: #f0fdf4; }
        
        /* OVERRIDE TECHNICAL FONT TO MONTSERRAT */
        .font-mono-tech { font-family: 'Montserrat', sans-serif !important; letter-spacing: -0.02em; }

        /* Background Pattern */
        .bg-golf {
            background-color: #064e3b;
            background-image: radial-gradient(#065f46 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- CARD DESIGN --- */
        .flight-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid #f0fdf4;
        }
        
        .flight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #d1fae5;
        }

        /* Header Style */
        .flight-header {
            background: linear-gradient(to right, #064e3b, #065f46);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .flight-number-box {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(8px);
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif; /* Changed */
            font-size: 24px;
            font-weight: 800; /* Extra Bold for Numbers */
            color: #fbbf24; 
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .group-badge {
            background-color: white;
            color: #14532d;
            font-weight: 800;
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-family: 'Montserrat', sans-serif;
        }

        /* Player List Styles */
        .player-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px dashed #cbd5e1;
            transition: background-color 0.2s;
        }
        
        .player-row:hover { background-color: #f8fafc; }
        .player-row:last-child { border-bottom: none; }

        .player-avatar-wrapper {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #ecfdf5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
            color: #065f46;
            overflow: hidden;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .badge-hdc-square {
            background-color: #15803d; /* Green 700 */
            color: white;
            min-width: 32px;
            height: 32px;
            padding: 0 6px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif; /* Changed */
            font-weight: 700;
            font-size: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- MAGIC ANIMATION --- */
        #magic-overlay {
            background: rgba(6, 78, 59, 0.98);
            backdrop-filter: blur(20px);
        }
        .hud-circle {
            position: relative;
            width: 200px; height: 200px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.1) 0%, rgba(0,0,0,0) 70%);
        }
        .hud-ring {
            position: absolute; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid transparent;
            border-top-color: #fbbf24; border-right-color: #f59e0b;
            animation: spin-right 2s linear infinite;
        }
        @keyframes spin-right { 100% { transform: rotate(360deg); } }
        
        .decipher-text {
            font-family: 'Montserrat', sans-serif; /* Changed */
            font-weight: 800;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.8);
            color: #fbbf24;
            letter-spacing: 0.05em;
        }
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800 bg-gray-50">

    <div id="magic-overlay" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center text-white overflow-hidden">
        <div class="relative z-10 flex flex-col items-center">
            <div class="hud-circle mb-8">
                <div class="hud-ring"></div>
                <i class="fa-solid fa-golf-ball-tee text-5xl text-yellow-400 animate-pulse"></i>
            </div>
            <div class="text-center space-y-2">
                <p class="text-green-200 text-xs font-bold tracking-[0.2em] uppercase">System Processing</p>
                <h2 id="magic-name" class="text-3xl md:text-5xl font-extrabold text-white decipher-text min-h-[60px]">INITIALIZING...</h2>
                <p id="magic-status" class="text-green-200 text-sm font-medium">Fetching Data...</p>
            </div>
            <div class="w-80 h-1 bg-green-900 mt-8 rounded-full overflow-hidden relative border border-green-700">
                <div id="magic-progress" class="h-full bg-yellow-400 w-0 shadow-[0_0_10px_rgba(251,191,36,0.8)]"></div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden modal-enter border border-gray-100">
            <div class="bg-slate-50 px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-shuffle text-green-700"></i> Xác nhận chia nhóm
                </h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6">
                <p class="text-slate-600 text-sm leading-relaxed mb-3 font-medium">
                    Hệ thống sẽ tải lại dữ liệu từ Google Sheet và xử lý:
                </p>
                <ul class="text-xs text-slate-500 space-y-2 pl-2 border-l-2 border-green-200 ml-1 font-medium">
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-green-700">1.</span>
                        <span>Chia ngẫu nhiên theo <b>Bảng</b> (A trước, B sau).</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-green-700">2.</span>
                        <span>Bảng <b>A</b> sẽ được chia theo HDC <=23</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-green-700">2.</span>
                        <span>Bảng <b>A</b> sẽ được chia theo HDC >23.</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="font-bold text-green-700">3.</span>
                        <span>Dữ liệu cũ sẽ bị xóa hoàn toàn.</span>
                    </li>
                </ul>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-100">
                <button onclick="closeModal()" class="px-5 py-2.5 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-200 transition border border-gray-300">Hủy</button>
                <button onclick="confirmReshuffle()" class="px-5 py-2.5 rounded-lg text-sm font-bold text-white bg-green-700 hover:bg-green-800 shadow-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-play"></i> Bắt đầu
                </button>
            </div>
        </div>
    </div>

    <header class="bg-golf text-white relative shadow-2xl overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-black/70 to-transparent"></div>
        <div class="container mx-auto px-4 py-6 relative z-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-4">
                    <div class="bg-white/10 p-3 rounded-full backdrop-blur-sm border border-white/20 shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                        <i class="fa-solid fa-trophy text-3xl text-yellow-400"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-extrabold text-white tracking-tight drop-shadow-lg uppercase">WOB YEAR-END OUTING 2025</h1>
                        <p class="text-gray-300 text-sm font-semibold mt-1 tracking-wide"><i class="fa-solid fa-location-dot mr-2 text-yellow-400"></i>Sân Đông - Thủ Đức | 28/11/2025</p>
                    </div>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-3 border border-white/10 text-sm min-w-[200px] shadow-lg text-center">
                    <div class="text-gray-300 text-xs uppercase tracking-wider mb-1 font-bold">Tổng người chơi</div>
                    <div class="text-3xl font-extrabold text-yellow-400" id="total-players-display">--</div>
                </div>
            </div>
            <div class="mt-6 flex flex-wrap gap-3 border-t border-white/10 pt-4">
                <button onclick="copyToClipboard()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-5 rounded-lg shadow transition flex items-center gap-2 text-sm">
                    <i class="fa-regular fa-copy"></i> Copy Excel
                </button>
                <div class="flex-grow"></div>
                <button onclick="openModal()" class="bg-white text-red-600 hover:bg-red-50 font-bold py-2 px-5 rounded-lg shadow transition flex items-center gap-2 text-sm border border-red-100">
                    <i class="fa-solid fa-arrows-rotate"></i> Tải & Chia Lại
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 -mt-4 relative z-20">
        <div class="flex items-center gap-2 mb-4">
             <i class="fa-solid fa-list-ol text-green-700 text-xl"></i>
             <h2 class="text-xl font-bold text-gray-800">Danh sách Flight</h2>
        </div>
        <div id="fly-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </main>

    <footer class="bg-slate-900 text-slate-500 py-6 text-center text-xs border-t border-slate-800">
        <p class="font-bold tracking-wider">WOB GOLF v1.1</p>
    </footer>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 opacity-0 translate-y-10 flex items-center gap-3">
        <i class="fa-solid fa-circle-check text-green-400"></i>
        <span id="toast-msg" class="font-medium">Thông báo hệ thống</span>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            startDate: "28/11/2025",
            startTime: "06:37", 
            interval: 7,        
            storageKey: "WOB_OUTING_STRICT_V3_FINAL", 
            sheetCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSl-c25LTQMr5-usqXvTRhhRXgpf7w9hzlX8JjXLVppuDcD8vIXg5TXAc31kWRe3aXBjRN4Ikpdukl3/pub?gid=2114872903&single=true&output=csv"
        };

        let currentFlights = [];
        let rawPlayers = [];

        function init() {
            const savedData = localStorage.getItem(CONFIG.storageKey);
            if (savedData) {
                currentFlights = JSON.parse(savedData);
                updateStats(currentFlights);
                renderFlights();
            } else {
                openModal();
            }
        }

        // --- FETCH DATA ROBUSTLY ---
        async function fetchAndParseData() {
            return new Promise((resolve, reject) => {
                Papa.parse(CONFIG.sheetCsvUrl, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: function(h) {
                        return h.trim().toLowerCase();
                    },
                    complete: function(results) {
                        const cleaned = results.data.map(row => {
                            return {
                                name: row['playername'] || "Unknown",
                                vga: row['vga'] || "N/A",
                                hdc: parseInt(row['handicap']) || 0,
                                group: row['group'] ? row['group'].trim().toUpperCase() : "A",
                                isRandom: row['israndom'] ? row['israndom'].trim().toUpperCase() : "Y",
                                priority: parseInt(row['priorityflytime']) || 0
                            };
                        });
                        resolve(cleaned);
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            });
        }

        function generateSafeAvatar(name) {
            const styles = ["shortFlat", "theCaesar", "theCaesarSidePart", "shortRound", "shortWaved"];
            const randomStyle = styles[Math.floor(Math.random() * styles.length)];
            return `https://api.dicebear.com/9.x/avataaars/svg?seed=${encodeURIComponent(name)}&top=${randomStyle}&eyebrows=default&mouth=smile&clothing=collarAndSweater&clothingColor=3c4f5c,65c9ff,262e33`;
        }
        function getInitials(name) { return name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase(); }

        // --- UI HANDLERS ---
        function openModal() { document.getElementById('confirm-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('confirm-modal').classList.add('hidden'); }
        function confirmReshuffle() { closeModal(); startMagicSequence(); }

        async function startMagicSequence() {
            const overlay = document.getElementById('magic-overlay');
            const magicName = document.getElementById('magic-name');
            const magicStatus = document.getElementById('magic-status');
            const progressBar = document.getElementById('magic-progress');
            
            overlay.classList.remove('hidden');
            progressBar.style.width = '10%';
            
            try {
                localStorage.removeItem(CONFIG.storageKey);
                
                magicStatus.innerText = "Downloading CSV...";
                rawPlayers = await fetchAndParseData();
                progressBar.style.width = '60%';
                
                let step = 0;
                const interval = setInterval(() => {
                    const r = rawPlayers[Math.floor(Math.random() * rawPlayers.length)];
                    magicName.innerText = r.name.toUpperCase();
                    step++;
                    if(step > 20) magicStatus.innerText = "Segregating Groups...";
                }, 50);

                setTimeout(() => {
                    clearInterval(interval);
                    generateFlightsStrictLogic();
                    progressBar.style.width = '100%';
                    magicName.innerText = "DONE";
                    setTimeout(() => overlay.classList.add('hidden'), 500);
                }, 2500);

            } catch (error) {
                alert("Lỗi tải dữ liệu: " + error.message);
                overlay.classList.add('hidden');
            }
        }

        // --- STRICT GROUP LOGIC ---
        function generateFlightsStrictLogic() {
            const distinctGroups = [...new Set(rawPlayers.map(p => p.group))].sort();
            let finalOrderedFlights = [];

            distinctGroups.forEach(groupName => {
                const groupPlayers = rawPlayers.filter(p => p.group === groupName);

                if (groupPlayers.length === 0) return;

                let fixed = groupPlayers.filter(p => p.isRandom === 'N');
                let random = groupPlayers.filter(p => p.isRandom !== 'N');

                fixed.sort((a, b) => a.hdc - b.hdc);
                random = shuffle(random);

                let currentGroupFlights = [];

                const processList = (list) => {
                    while(list.length > 0) {
                        const chunk = list.splice(0, 4);
                        let pValues = chunk.map(p => p.priority).filter(p => p > 0);
                        let flightPriority = pValues.length > 0 ? Math.min(...pValues) : 999;

                        currentGroupFlights.push({
                            players: chunk,
                            groupName: groupName,
                            sortPriority: flightPriority,
                            totalHDC: chunk.reduce((sum, p) => sum + p.hdc, 0)
                        });
                    }
                };

                processList(fixed);
                processList(random);

                currentGroupFlights.sort((a, b) => a.sortPriority - b.sortPriority);
                finalOrderedFlights.push(...currentGroupFlights);
            });

            currentFlights = finalOrderedFlights.map((f, index) => ({
                flyNo: index + 1,
                teeTime: calculateTeeTime(CONFIG.startTime, index, CONFIG.interval),
                players: f.players,
                groupName: f.groupName,
                totalHDC: f.totalHDC
            }));

            localStorage.setItem(CONFIG.storageKey, JSON.stringify(currentFlights));
            updateStats(currentFlights);
            renderFlights();
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function calculateTeeTime(startStr, index, interval) {
            let [hours, minutes] = startStr.split(':').map(Number);
            let totalMinutes = hours * 60 + minutes + (index * interval);
            let h = Math.floor(totalMinutes / 60);
            let m = totalMinutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function updateStats(flights) {
            let total = 0;
            flights.forEach(f => total += f.players.length);
            document.getElementById('total-players-display').innerText = total;
        }

        function renderFlights() {
            const grid = document.getElementById('fly-grid');
            grid.innerHTML = '';

            currentFlights.forEach(fly => {
                let playersHtml = fly.players.map(p => {
                    const avatarUrl = generateSafeAvatar(p.name);
                    const initials = getInitials(p.name);
                    
                    return `
                    <div class="player-row group">
                        <div class="player-avatar-wrapper">
                            <img src="${avatarUrl}" class="w-full h-full object-cover" 
                                 onerror="this.parentNode.innerHTML='${initials}'" alt="${p.name}">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm text-gray-800 truncate uppercase" title="${p.name}">${p.name}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] text-gray-500 font-bold bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">VGA: ${p.vga}</span>
                                ${p.priority > 0 ? `<i class="fa-solid fa-star text-yellow-400 text-[10px]" title="Priority"></i>` : ''}
                            </div>
                        </div>
                        <div class="ml-2">
                             <div class="badge-hdc-square">${p.hdc}</div>
                        </div>
                    </div>
                `}).join('');

                if(fly.players.length < 4) {
                    for(let i=0; i < (4 - fly.players.length); i++) {
                         playersHtml += `
                         <div class="player-row opacity-40">
                            <div class="player-avatar-wrapper bg-slate-100 border-slate-200">
                                <i class="fa-solid fa-user-plus text-slate-300"></i>
                            </div>
                            <div class="flex-1 text-sm text-slate-400 italic font-medium">Available Slot</div>
                         </div>`;
                    }
                }

                const card = document.createElement('div');
                card.className = "flight-card";
                card.innerHTML = `
                    <div class="flight-header">
                        <div class="flex items-center gap-3 relative z-10">
                            <div class="flight-number-box">${fly.flyNo}</div>
                            <div>
                                <div class="text-[10px] text-green-200 uppercase tracking-widest font-bold mb-0.5 opacity-80">FLIGHT</div>
                                <div class="text-xl font-bold flex items-center gap-2">
                                    <i class="fa-regular fa-clock text-xs"></i> ${fly.teeTime}
                                </div>
                            </div>
                        </div>
                        <div class="group-badge">GROUP ${fly.groupName}</div>
                    </div>
                    <div class="flex-grow bg-white relative">${playersHtml}</div>
                `;
                grid.appendChild(card);
            });
        }

        function copyToClipboard() {
            let content = "FlyNo\tTeeTime\tGroup\tPlayerName\tVGA\tHandicap\tFlightHDC\n";
            currentFlights.forEach(fly => {
                fly.players.forEach(p => {
                    content += `${fly.flyNo}\t${fly.teeTime}\t${fly.groupName}\t${p.name}\t${p.vga}\t${p.hdc}\t${fly.totalHDC}\n`;
                });
            });
            navigator.clipboard.writeText(content).then(() => {
                showToast("Đã copy dữ liệu!");
            });
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        }

        init();
    </script>
</body>
</html>
