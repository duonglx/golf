<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOB Golf Tournament Pairing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #f3f4f6; /* Light Gray */
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .font-mono-tech { font-family: 'Share Tech Mono', monospace; }

        /* Card Styles */
        .flight-card {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            background: white;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .flight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Header Card Style */
        .card-header {
            background-color: #064e3b; /* Emerald 900 */
            color: white;
            padding: 1rem;
            position: relative;
        }
        
        .flight-number-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.5rem;
            color: #facc15; /* Gold */
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Player Row Style */
        .player-row {
            border-bottom: 1px dashed #e5e7eb;
        }
        .player-row:last-child {
            border-bottom: none;
        }

        /* Badges */
        .badge-hdc {
            background-color: #10b981; /* Emerald 500 */
            color: white;
            font-family: 'Share Tech Mono', monospace;
            border-radius: 6px;
            padding: 2px 8px;
            font-weight: bold;
            min-width: 35px;
            text-align: center;
        }
        
        .badge-vga {
            background-color: #f3f4f6;
            color: #6b7280;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
            margin-top: 2px;
        }

        .avatar-circle {
            background: #f0fdf4;
            color: #166534;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Loading Overlay */
        #loading-overlay {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <div id="loading-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
        <div class="relative w-20 h-20 mb-4">
            <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-emerald-600 rounded-full border-t-transparent animate-spin"></div>
            <i class="fa-solid fa-golf-ball-tee absolute inset-0 m-auto flex items-center justify-center text-emerald-600 text-xl"></i>
        </div>
        <h2 class="text-xl font-bold text-emerald-800 tracking-wider animate-pulse">LOADING DATA...</h2>
        <p class="text-sm text-gray-500 mt-2 font-mono" id="loading-status">Connecting to Google Sheets...</p>
    </div>

    <header class="bg-[#064e3b] text-white shadow-xl relative overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
        <div class="container mx-auto px-4 py-6 relative z-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 w-12 h-12 rounded-full flex items-center justify-center shadow-lg border-2 border-white/20">
                        <i class="fa-solid fa-trophy text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-extrabold text-white tracking-tight">WOB TOURNAMENT</h1>
                        <p class="text-emerald-300 text-sm font-medium font-mono-tech tracking-wider uppercase">Pairing System 2.5</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="fetchGoogleSheet()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-lg shadow-lg transition flex items-center gap-2 font-semibold text-sm border border-emerald-500/50">
                        <i class="fa-solid fa-arrows-rotate"></i> Reload Data
                    </button>
                    <button onclick="copyToClipboard()" class="bg-white text-emerald-800 hover:bg-gray-100 px-5 py-2.5 rounded-lg shadow-lg transition flex items-center gap-2 font-semibold text-sm">
                        <i class="fa-regular fa-copy"></i> Copy Text
                    </button>
                </div>
            </div>
            
            <div class="mt-6 flex flex-wrap gap-4 text-xs md:text-sm border-t border-emerald-800/50 pt-4">
                 <div class="flex items-center gap-2">
                    <i class="fa-solid fa-clock text-yellow-400"></i>
                    <span class="text-emerald-100">Tee Time: <b class="text-white font-mono-tech">06:37</b></span>
                 </div>
                 <div class="flex items-center gap-2">
                    <i class="fa-solid fa-users text-yellow-400"></i>
                    <span class="text-emerald-100">Total Players: <b class="text-white font-mono-tech" id="total-count">0</b></span>
                 </div>
                 <div class="flex-grow"></div>
                 <div class="text-emerald-300 italic text-[10px]">Data Source: Google Sheets (HDC)</div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8">
        <div id="fly-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 opacity-0 translate-y-10 flex items-center gap-3">
        <i class="fa-solid fa-circle-check text-green-400"></i>
        <span id="toast-msg">Thông báo hệ thống</span>
    </div>

    <script>
        const CONFIG = {
            // Link Gốc: https://docs.google.com/spreadsheets/d/e/2PACX-1vSl-c25LTQMr5-usqXvTRhhRXgpf7w9hzlX8JjXLVppuDcD8vIXg5TXAc31kWRe3aXBjRN4Ikpdukl3/pubhtml
            // Chuyển đổi sang CSV endpoint để fetch dữ liệu
            sheetId: "2PACX-1vSl-c25LTQMr5-usqXvTRhhRXgpf7w9hzlX8JjXLVppuDcD8vIXg5TXAc31kWRe3aXBjRN4Ikpdukl3",
            startTime: "06:37", 
            interval: 7, // phút
        };

        let currentFlights = [];
        let rawPlayers = [];

        // --- 1. DATA FETCHING ---
        function fetchGoogleSheet() {
            const loading = document.getElementById('loading-overlay');
            const status = document.getElementById('loading-status');
            loading.classList.remove('hidden');
            status.innerText = "Downloading CSV from Google...";

            // Construct CSV URL
            const csvUrl = `https://docs.google.com/spreadsheets/d/e/${CONFIG.sheetId}/pub?output=csv`;

            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        status.innerText = "Processing Logic...";
                        rawPlayers = results.data.map(row => ({
                            name: row['PlayerName'] || "Unknown",
                            vga: row['VGA'] || "0000",
                            hdc: parseFloat(row['Handicap']) || 0,
                            group: (row['Group'] || "A").trim().toUpperCase(),
                            isRandom: (row['IsRandom'] || "Y").trim().toUpperCase(),
                            priority: parseInt(row['PriorityFlyTime']) || 99, // Mặc định độ ưu tiên thấp nếu không có
                        }));
                        
                        document.getElementById('total-count').innerText = rawPlayers.length;
                        processPairingLogic();
                    } else {
                        alert("Không tìm thấy dữ liệu hoặc lỗi file CSV!");
                        loading.classList.add('hidden');
                    }
                },
                error: function(err) {
                    console.error("Error:", err);
                    alert("Lỗi kết nối Google Sheet: " + err.message);
                    loading.classList.add('hidden');
                }
            });
        }

        // --- 2. PAIRING LOGIC (CORE) ---
        function processPairingLogic() {
            // Lấy danh sách các Group duy nhất (A, B, C...)
            const uniqueGroups = [...new Set(rawPlayers.map(p => p.group))].sort();
            
            let allFlights = [];

            uniqueGroups.forEach(groupName => {
                // Lọc người chơi trong Group này
                const groupPlayers = rawPlayers.filter(p => p.group === groupName);

                // Tách thành 2 tập: Cố định (Non-Random) và Ngẫu nhiên (Random)
                const fixedPlayers = groupPlayers.filter(p => p.isRandom === 'N');
                const randomPlayers = groupPlayers.filter(p => p.isRandom !== 'N');

                // Xử lý nhóm CỐ ĐỊNH: Sort theo HDC -> Chia nhóm 4
                // Giả định: Sort HDC từ thấp đến cao
                fixedPlayers.sort((a, b) => a.hdc - b.hdc);
                const fixedFlights = chunkArray(fixedPlayers, 4);

                // Xử lý nhóm NGẪU NHIÊN: Shuffle -> Chia nhóm 4
                // Dùng Seed random để mỗi lần F5 vẫn ra kết quả khác nhau (hoặc cố định nếu muốn)
                // Ở đây ta dùng Math.random() thực tế mỗi lần bấm nút
                const shuffledRandoms = shuffle(randomPlayers);
                const randomFlights = chunkArray(shuffledRandoms, 4);

                // Gộp vào danh sách flight chung
                // Lưu ý: Flight được tạo ra ở đây chưa có giờ TeeTime chuẩn, chỉ là gom nhóm
                [...fixedFlights, ...randomFlights].forEach(members => {
                    allFlights.push({
                        groupName: groupName,
                        players: members
                    });
                });
            });

            // --- QUY TẮC PriorityFlyTime ---
            // Sắp xếp các Flight dựa trên độ ưu tiên.
            // Logic: Flight nào chứa thành viên có Priority nhỏ nhất (1 là cao nhất) sẽ được đẩy lên đầu.
            allFlights.sort((flyA, flyB) => {
                const getMinPriority = (flight) => {
                    // Tìm số priority nhỏ nhất trong nhóm 4 người (số càng nhỏ càng ưu tiên)
                    // Nếu không có priority hợp lệ (<=0 hoặc >8), coi như là 99
                    const priorities = flight.players.map(p => (p.priority >= 1 && p.priority <= 8) ? p.priority : 99);
                    return Math.min(...priorities);
                };

                return getMinPriority(flyA) - getMinPriority(flyB);
            });

            // Gán số thứ tự và giờ TeeTime sau khi đã sắp xếp
            currentFlights = allFlights.map((fly, index) => {
                return {
                    flyNo: index + 1,
                    teeTime: calculateTeeTime(CONFIG.startTime, index, CONFIG.interval),
                    groupName: fly.groupName, // Group đại diện (thường là giống nhau cả nhóm)
                    players: fly.players.map(p => ({
                        ...p,
                        avatarUrl: generateSafeAvatar(p.name)
                    }))
                };
            });

            // Render ra màn hình
            setTimeout(() => {
                renderFlights();
                document.getElementById('loading-overlay').classList.add('hidden');
                showToast("Dữ liệu đã được cập nhật thành công!");
            }, 800); // Fake delay for UX
        }

        // --- 3. UTILS & HELPERS ---
        
        function chunkArray(array, size) {
            const results = [];
            for (let i = 0; i < array.length; i += size) {
                results.push(array.slice(i, i + size));
            }
            return results;
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            // While there remain elements to shuffle.
            while (currentIndex != 0) {
                // Pick a remaining element.
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function calculateTeeTime(startStr, index, interval) {
            let [hours, minutes] = startStr.split(':').map(Number);
            let totalMinutes = hours * 60 + minutes + (index * interval);
            let h = Math.floor(totalMinutes / 60);
            let m = totalMinutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        // Fix DiceBear v9 API
        function generateSafeAvatar(name) {
            // Style nam tính, tóc ngắn
            const maleHairStyles = ["shortCurly","shortDreads1","shortDreads2","shortFlat","shortRound","shortWaved","sides","theCaesar","theCaesarSidePart"];
            // Chọn tóc dựa trên tên để cố định (không random mỗi lần render lại UI)
            const seed = name.replace(/\s/g, ''); 
            const hairIndex = seed.length % maleHairStyles.length;
            const hair = maleHairStyles[hairIndex];
            
            // API V9 Construction
            return `https://api.dicebear.com/9.x/avataaars/svg?seed=${seed}&top[]=${hair}&facialHairProbability=20&backgroundColor=b6e3f4,c0aede,d1d4f9`;
        }

        function getInitial(name) {
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        // --- 4. RENDER UI ---
        function renderFlights() {
            const grid = document.getElementById('fly-grid');
            grid.innerHTML = '';

            currentFlights.forEach(fly => {
                // Build Player Rows
                let playersHtml = fly.players.map(p => `
                    <div class="player-row flex items-center gap-3 py-3 px-4 hover:bg-slate-50 transition">
                        <div class="relative flex-shrink-0">
                            <img src="${p.avatarUrl}" class="w-10 h-10 rounded-full bg-gray-100 border border-gray-200 object-cover shadow-sm" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${p.name}&background=random'">
                            <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-[2px]">
                                <div class="bg-emerald-500 w-2.5 h-2.5 rounded-full"></div>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm text-slate-800 truncate" title="${p.name}">${p.name}</div>
                            <span class="badge-vga">VGA: ${p.vga}</span>
                        </div>
                        <div class="text-right">
                            <div class="badge-hdc shadow-sm">${p.hdc}</div>
                        </div>
                    </div>
                `).join('');

                // Fill Empty Slots if < 4 players
                if (fly.players.length < 4) {
                    for(let i=0; i < (4 - fly.players.length); i++) {
                         playersHtml += `
                            <div class="player-row flex items-center gap-3 py-3 px-4 opacity-40">
                                <div class="w-10 h-10 rounded-full bg-gray-200 border-2 border-dashed border-gray-300 flex items-center justify-center">
                                    <i class="fa-solid fa-user text-gray-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                                </div>
                            </div>
                         `;
                    }
                }

                // Create Card Element
                const card = document.createElement('div');
                card.className = "flight-card";
                card.innerHTML = `
                    <div class="card-header flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="flight-number-box">
                                ${fly.flyNo}
                            </div>
                            <div>
                                <div class="text-[10px] text-emerald-200 font-bold tracking-widest uppercase mb-0.5">FLIGHT</div>
                                <div class="font-mono-tech text-xl font-bold flex items-center gap-1">
                                    <i class="fa-regular fa-clock text-xs text-emerald-300"></i> ${fly.teeTime}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-xs text-emerald-300 font-bold uppercase tracking-wider">Group</span>
                            <span class="text-xl font-bold font-mono-tech text-white">${fly.groupName}</span>
                        </div>
                    </div>
                    <div class="bg-white flex-grow flex flex-col justify-center">
                        ${playersHtml}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- 5. EXPORT ---
        function copyToClipboard() {
            if (currentFlights.length === 0) {
                showToast("Chưa có dữ liệu để copy!");
                return;
            }
            let content = "FlyNo\tTeeTime\tGroup\tPlayerName\tVGA\tHandicap\n";
            currentFlights.forEach(fly => {
                fly.players.forEach(p => {
                    content += `${fly.flyNo}\t${fly.teeTime}\t${fly.groupName}\t${p.name}\t${p.vga}\t${p.hdc}\n`;
                });
            });
            navigator.clipboard.writeText(content).then(() => {
                showToast("Đã copy dữ liệu vào Clipboard!");
            }).catch(err => {
                alert("Lỗi copy: " + err);
            });
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        // Auto Load on Start
        window.addEventListener('DOMContentLoaded', fetchGoogleSheet);

    </script>
</body>
</html>
